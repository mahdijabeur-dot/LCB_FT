<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contr√¥le LCB-FT ‚Äî Saisie en Lot</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --navy:    #0a1628;
      --blue:    #1a3a6b;
      --blue-mid:#1e4d9b;
      --accent:  #c8102e;
      --gold:    #d4a017;
      --success: #1a7a45;
      --warning: #c47c00;
      --danger:  #c8102e;
      --orange:  #d4620a;
      --muted:   #6b7a8d;
      --bg:      #f0f2f5;
      --surface: #ffffff;
      --border:  #dde1e9;
      --text:    #1a202c;
      --text-sm: #4a5568;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'IBM Plex Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .header {
      background: linear-gradient(120deg, var(--navy) 0%, var(--blue) 60%, var(--blue-mid) 100%);
      padding: 0 40px;
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
    }
    .header-inner {
      max-width: 1280px; margin: 0 auto;
      display: flex; align-items: center; justify-content: space-between;
      height: 70px;
    }
    .header-brand {
      display: flex; align-items: center; gap: 16px;
    }
    .header-logo {
      width: 42px; height: 42px;
      background: var(--accent);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem; font-weight: 700; color: #fff;
      letter-spacing: -1px; flex-shrink: 0;
    }
    .header-title { color: #fff; }
    .header-title h1 { font-size: 1.05rem; font-weight: 600; letter-spacing: 0.3px; }
    .header-title p  { font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px; }
    .header-meta {
      display: flex; align-items: center; gap: 20px;
    }
    .badge-lot {
      background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px; padding: 5px 14px;
      font-size: 0.8rem; color: #fff; font-weight: 500;
    }
    .badge-lot strong { color: #ffd700; }
    .badge-version {
      font-size: 0.7rem; color: rgba(255,255,255,0.45);
      font-family: 'IBM Plex Mono', monospace;
    }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .container { max-width: 1280px; margin: 0 auto; padding: 28px 40px; }

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.04);
      overflow: hidden;
    }
    .card-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: #fafbfd;
      display: flex; align-items: center; justify-content: space-between;
    }
    .card-header h2 {
      font-size: 0.95rem; font-weight: 600;
      color: var(--blue); display: flex; align-items: center; gap: 8px;
    }
    .card-header h2 .icon { font-size: 1.1rem; }
    .card-body { padding: 24px; }

    /* ‚îÄ‚îÄ FORM GRID ‚îÄ‚îÄ */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label {
      font-size: 0.78rem; font-weight: 600;
      color: var(--text-sm); text-transform: uppercase; letter-spacing: 0.5px;
    }
    .form-group label .req { color: var(--danger); margin-left: 2px; }
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 9px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.88rem;
      font-family: inherit;
      color: var(--text);
      background: #fff;
      transition: border-color 0.15s, box-shadow 0.15s;
      width: 100%;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--blue-mid);
      box-shadow: 0 0 0 3px rgba(30,77,155,0.12);
    }
    .form-group input[readonly] {
      background: #f4f6fa; color: var(--muted); font-family: 'IBM Plex Mono', monospace; font-size: 0.85rem;
    }
    .form-group textarea { resize: vertical; min-height: 72px; }

    /* ‚îÄ‚îÄ SEPARATOR ‚îÄ‚îÄ */
    .section-sep {
      margin: 22px 0 18px;
      display: flex; align-items: center; gap: 12px;
    }
    .section-sep h3 {
      font-size: 0.8rem; font-weight: 700; color: var(--blue);
      text-transform: uppercase; letter-spacing: 0.8px; white-space: nowrap;
    }
    .section-sep::after {
      content: ''; flex: 1; height: 1px; background: var(--border);
    }

    /* ‚îÄ‚îÄ POINTS DE CONTR√îLE ‚îÄ‚îÄ */
    #controls-section { display: none; margin-top: 22px; }
    .controls-list { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    .control-item {
      display: grid;
      grid-template-columns: 1fr 165px 1fr;
      gap: 12px;
      align-items: center;
      padding: 11px 16px;
      border-bottom: 1px solid #f0f2f5;
      transition: background 0.1s;
    }
    .control-item:last-child { border-bottom: none; }
    .control-item:hover { background: #fafbfd; }
    .ctrl-label { font-size: 0.86rem; }
    .ctrl-id {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem; font-weight: 600;
      color: var(--blue-mid);
      background: rgba(30,77,155,0.08);
      padding: 2px 7px; border-radius: 4px;
      margin-right: 8px; display: inline-block;
    }
    .ctrl-text { font-weight: 500; }
    .eval-select, .ctrl-comment {
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: 5px;
      font-size: 0.82rem;
      font-family: inherit;
      background: #fff;
      width: 100%;
    }
    .eval-select:focus, .ctrl-comment:focus {
      outline: none; border-color: var(--blue-mid);
      box-shadow: 0 0 0 2px rgba(30,77,155,0.1);
    }

    /* ‚îÄ‚îÄ RISK SCORE PREVIEW ‚îÄ‚îÄ */
    .score-preview {
      margin-top: 16px; padding: 14px 18px;
      background: #f4f6fa; border: 1px solid var(--border);
      border-radius: 8px;
      display: flex; align-items: center; gap: 20px;
    }
    .score-label { font-size: 0.8rem; font-weight: 600; color: var(--text-sm); text-transform: uppercase; letter-spacing: 0.4px; }
    .score-bar-wrap { flex: 1; height: 8px; background: #dde1e9; border-radius: 4px; overflow: hidden; }
    .score-bar { height: 100%; border-radius: 4px; transition: width 0.4s, background 0.4s; width: 0%; }
    .score-value { font-size: 1.1rem; font-weight: 700; font-family: 'IBM Plex Mono', monospace; min-width: 50px; text-align: right; }
    .score-badge {
      padding: 3px 10px; border-radius: 4px; color: #fff;
      font-size: 0.75rem; font-weight: 700; white-space: nowrap;
    }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn-row { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .btn {
      padding: 9px 18px;
      border: none; border-radius: 6px;
      cursor: pointer; font-weight: 600;
      font-size: 0.85rem; font-family: inherit;
      display: inline-flex; align-items: center; gap: 7px;
      transition: opacity 0.15s, transform 0.15s, box-shadow 0.15s;
    }
    .btn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.12); }
    .btn:active:not(:disabled) { transform: translateY(0); }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; }
    .btn-primary { background: var(--blue); color: #fff; }
    .btn-success { background: var(--success); color: #fff; }
    .btn-muted   { background: #e2e6ea; color: var(--text-sm); }
    .btn-danger  { background: var(--danger); color: #fff; }

    /* ‚îÄ‚îÄ LOT TABLE ‚îÄ‚îÄ */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
    thead tr { background: #f4f6fa; }
    th {
      padding: 11px 14px; text-align: left;
      font-size: 0.75rem; font-weight: 700;
      color: var(--text-sm); text-transform: uppercase; letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }
    td { padding: 9px 14px; border-bottom: 1px solid #f0f2f5; vertical-align: middle; }
    tbody tr:hover { background: #fafbfd; }
    tbody tr:last-child td { border-bottom: none; }
    .td-mono { font-family: 'IBM Plex Mono', monospace; font-size: 0.78rem; }
    .btn-del {
      padding: 4px 10px; font-size: 0.75rem;
      background: #fff; border: 1px solid var(--border);
      border-radius: 4px; cursor: pointer; color: var(--danger);
      font-weight: 600; transition: 0.15s;
    }
    .btn-del:hover { background: var(--danger); color: #fff; border-color: var(--danger); }

    /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
    .badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 3px 9px; border-radius: 4px;
      font-size: 0.72rem; font-weight: 700; white-space: nowrap;
    }
    .badge-conforme { background: #d4edda; color: #155724; }
    .badge-mineur   { background: #fff3cd; color: #856404; }
    .badge-majeur   { background: #ffe8d0; color: #8a3700; }
    .badge-critique { background: #f8d7da; color: #842029; }
    .badge-na       { background: #e9ecef; color: #6c757d; }

    /* ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ */
    .stats-row {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;
      margin-bottom: 18px;
    }
    .stat-card {
      background: #fafbfd; border: 1px solid var(--border);
      border-radius: 8px; padding: 14px 16px;
      text-align: center;
    }
    .stat-card .stat-val {
      font-size: 1.5rem; font-weight: 700; font-family: 'IBM Plex Mono', monospace;
      color: var(--blue);
    }
    .stat-card .stat-lbl { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

    /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
    .footer {
      text-align: center; padding: 20px;
      font-size: 0.75rem; color: var(--muted);
      border-top: 1px solid var(--border);
      margin-top: 12px;
    }

    /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
    .empty-state {
      text-align: center; padding: 40px 20px; color: var(--muted);
      font-size: 0.88rem;
    }
    .empty-state .icon { font-size: 2.5rem; display: block; margin-bottom: 10px; }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    .toast-container { position: fixed; bottom: 28px; right: 28px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
    .toast {
      background: var(--navy); color: #fff;
      padding: 12px 18px; border-radius: 8px;
      font-size: 0.84rem; font-weight: 500;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      display: flex; align-items: center; gap: 10px;
      animation: slideIn 0.25s ease-out;
    }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.error   { border-left: 4px solid var(--danger); }
    @keyframes slideIn { from { transform: translateX(60px); opacity: 0; } to { transform: none; opacity: 1; } }
    @keyframes fadeOut { to { opacity: 0; transform: translateX(60px); } }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="header">
  <div class="header-inner">
    <div class="header-brand">
      <div class="header-logo">LCB</div>
      <div class="header-title">
        <h1>Fiche de Contr√¥le LCB-FT ‚Äî Saisie en Lot</h1>
        <p>Syst√®me de collecte conforme CTAF / BCT ‚Äî Loi n¬∞ 2015-26</p>
      </div>
    </div>
    <div class="header-meta">
      <div class="badge-lot">Lot : <strong id="batch-count">0</strong> dossier(s)</div>
      <div class="badge-version">v2026.1</div>
    </div>
  </div>
</header>

<div class="container">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FORMULAIRE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card">
    <div class="card-header">
      <h2><span class="icon">üìù</span> Nouveau Dossier √† Contr√¥ler</h2>
    </div>
    <div class="card-body">

      <!-- Section 1 : Identification agence -->
      <div class="section-sep"><h3>1. Identification de l'Entit√©</h3></div>
      <div class="form-grid">
        <div class="form-group">
          <label>Agence / Entit√© <span class="req">*</span></label>
          <select id="designationAgence" required onchange="mettreAJourCodeAgence()">
            <option value="">‚Äî S√©lectionner l'agence ‚Äî</option>
            <option value="000">000 - AV.H.THAMEUR TUNIS</option>
            <option value="001">001 - R.AL JAZIRA TUNIS</option>
            <option value="002">002 - SOUSSE</option>
            <option value="003">003 - MAHDIA</option>
            <option value="004">004 - AV.H.CHAKER SFAX</option>
            <option value="005">005 - TUNIS PORT</option>
            <option value="006">006 - DAR CHAABANE ELFEHRI</option>
            <option value="007">007 - GABES</option>
            <option value="008">008 - BEJA</option>
            <option value="009">009 - KAIROUAN</option>
            <option value="010">010 - LE KEF</option>
            <option value="011">011 - BIZERTE</option>
            <option value="012">012 - TEBOURBA</option>
            <option value="013">013 - GROMBALIA</option>
            <option value="014">014 - RADES</option>
            <option value="015">015 - MENZEL BOURGUIBA</option>
            <option value="016">016 - JENDOUBA</option>
            <option value="017">017 - MONASTIR</option>
            <option value="018">018 - MOKNINE</option>
            <option value="019">019 - KSAR HELLAL</option>
            <option value="020">020 - ZARZIS</option>
            <option value="021">021 - GAFSA</option>
            <option value="022">022 - MANAR III</option>
            <option value="023">023 - KASSERINE</option>
            <option value="025">025 - JERBA</option>
            <option value="026">026 - HAJEB EL AYOUN</option>
            <option value="027">027 - EL OUARDANINE</option>
            <option value="028">028 - MEDENINE</option>
            <option value="029">029 - HAMMAMET</option>
            <option value="030">030 - BEN GARDANE</option>
            <option value="031">031 - NABEUL</option>
            <option value="032">032 - KORBA</option>
            <option value="033">033 - KELIBIA</option>
            <option value="034">034 - BAB SOUIKA</option>
            <option value="035">035 - R.K.PACHA TUNIS</option>
            <option value="036">036 - MEDINA TUNIS</option>
            <option value="037">037 - CITE MAHRAJ.MENZAH</option>
            <option value="038">038 - SFAX ZITOUNA</option>
            <option value="039">039 - SFAX HACHED</option>
            <option value="040">040 - M SAKEN</option>
            <option value="041">041 - EL-JEM</option>
            <option value="042">042 - JEMMAL</option>
            <option value="043">043 - PL.VICTOIRE TUNIS</option>
            <option value="044">044 - SIDI BOUZID</option>
            <option value="045">045 - MEGRINE</option>
            <option value="046">046 - TOZEUR</option>
            <option value="047">047 - SAKIET EZZIT</option>
            <option value="048">048 - TATAOUINE</option>
            <option value="049">049 - MENZEL TEMIME</option>
            <option value="050">050 - METLAOUI</option>
            <option value="051">051 - SAHLOUL</option>
            <option value="052">052 - LE KRAM</option>
            <option value="053">053 - KSOUR ESSAF</option>
            <option value="054">054 - ZAGHOUAN</option>
            <option value="055">055 - PONT DU FAHS</option>
            <option value="056">056 - ARIANA</option>
            <option value="057">057 - HAMMAM-LIF</option>
            <option value="058">058 - GHOMRASSEN</option>
            <option value="059">059 - AV.J.JAURES TUNIS</option>
            <option value="060">060 - GARE TUNIS</option>
            <option value="061">061 - SILIANA</option>
            <option value="062">062 - R.PALESTINE TUNIS</option>
            <option value="063">063 - JEBENIANA</option>
            <option value="064">064 - SOUSSE EL KANTAOUI</option>
            <option value="065">065 - SOLIMAN</option>
            <option value="066">066 - KHAZNADAR</option>
            <option value="067">067 - AIN-DRAHAM</option>
            <option value="068">068 - SKHIRA</option>
            <option value="069">069 - SEDJENANE</option>
            <option value="070">070 - RAS JEBEL</option>
            <option value="071">071 - TABARKA</option>
            <option value="072">072 - BIZERTE MEDINA</option>
            <option value="073">073 - FERIANA</option>
            <option value="074">074 - MATEUR</option>
            <option value="075">075 - SAKIET SIDI YOUSSEF</option>
            <option value="076">076 - KALAAT SENANE</option>
            <option value="077">077 - EL MANAR</option>
            <option value="078">078 - MONASTIR II</option>
            <option value="079">079 - TROCADERO (SOUSSE NR)</option>
            <option value="080">080 - ENFIDHA</option>
            <option value="081">081 - CITE ETTADHAMEN</option>
            <option value="082">082 - FOUCHANA</option>
            <option value="083">083 - JELMA</option>
            <option value="084">084 - BOUSALEM</option>
            <option value="085">085 - HAOUARIA</option>
            <option value="086">086 - KSIBET EL MEDIOUNI</option>
            <option value="087">087 - BEN AROUS</option>
            <option value="088">088 - SFAX MOULINVILLE</option>
            <option value="089">089 - SOUSSE REPUBLIQUE</option>
            <option value="100">100 - AGENCE CENTRALE A. MATHARI</option>
            <option value="101">101 - KEBILI</option>
            <option value="102">102 - JERBA MIDOUN</option>
            <option value="103">103 - MARETH</option>
            <option value="104">104 - SFAX PORT</option>
            <option value="105">105 - NABEUL II</option>
            <option value="106">106 - AKOUDA</option>
            <option value="107">107 - LA CHARGUIA</option>
            <option value="108">108 - LE BELVEDERE</option>
            <option value="109">109 - BENI KHALLED</option>
            <option value="110">110 - AEROPORT TUNIS-CARTH</option>
            <option value="112">112 - HAMMAM SOUSSE</option>
            <option value="113">113 - HAMMAMET ETTAHRIR</option>
            <option value="114">114 - SFAX JEDIDA</option>
            <option value="115">115 - GABES-CENTER</option>
            <option value="116">116 - AFRICA</option>
            <option value="118">118 - EL MOUANSA ZARZIS</option>
            <option value="119">119 - EL MOUROUJ</option>
            <option value="120">120 - DOUZ</option>
            <option value="121">121 - OUED ELLIL</option>
            <option value="122">122 - NEFZA</option>
            <option value="123">123 - MSAKEN II</option>
            <option value="124">124 - CITE DES SCIENCES</option>
            <option value="125">125 - AV. MOHAMED V</option>
            <option value="126">126 - EL HRAIRIA</option>
            <option value="127">127 - HAMMAMET SUD</option>
            <option value="128">128 - MENZEL KAMEL MOUNAS</option>
            <option value="129">129 - LA MARSA</option>
            <option value="130">130 - KERKENNAH</option>
            <option value="131">131 - LAOUINA</option>
            <option value="132">132 - SIDI ALOUENE</option>
            <option value="133">133 - SOUSSE INES</option>
            <option value="134">134 - MOKTHAR ATTIA</option>
            <option value="135">135 - LAC II</option>
            <option value="136">136 - HAMMAMET MEDINA</option>
            <option value="137">137 - SFAX TYNA</option>
            <option value="138">138 - SFAX CHIHIA</option>
            <option value="139">139 - EZZAHRA</option>
            <option value="140">140 - GAFSA II</option>
            <option value="141">141 - SOUKRA</option>
            <option value="142">142 - ENNASR</option>
            <option value="143">143 - SFAX EL AFRAN</option>
            <option value="144">144 - CHENINI GABES</option>
            <option value="145">145 - BENI KHEDACHE</option>
            <option value="146">146 - REDAYEF</option>
            <option value="147">147 - BIZERTE CORNICHE</option>
            <option value="148">148 - JERBA EL MAY</option>
            <option value="149">149 - MREZGUA</option>
            <option value="150">150 - JENDOUBA NORD</option>
            <option value="151">151 - TEBOULBA</option>
            <option value="152">152 - SOUSSE ERRIADH</option>
            <option value="153">153 - RIADH EL ANDALOUS</option>
            <option value="154">154 - KALAA EL KEBIRA</option>
            <option value="155">155 - SAKIET EDDAIER</option>
            <option value="156">156 - SBEITLA</option>
            <option value="157">157 - TESTOUR</option>
            <option value="158">158 - MANOUBA</option>
            <option value="159">159 - MGHIRA</option>
            <option value="160">160 - JERBA HOUMET SOUK 2</option>
            <option value="161">161 - SFAX POUDRIERE</option>
            <option value="162">162 - EL HAMMA</option>
            <option value="163">163 - MNIHLA</option>
            <option value="164">164 - JARDINS DE CARTHAGE</option>
          </select>
        </div>
        <div class="form-group">
          <label>Code Agence</label>
          <input type="text" id="codeAgence" readonly placeholder="Auto-rempli">
        </div>
        <div class="form-group">
          <label>Contr√¥leur / Auditeur <span class="req">*</span></label>
          <input type="text" id="controleur" placeholder="Nom Pr√©nom">
        </div>
      </div>

      <!-- Section 2 : Dossier -->
      <div class="section-sep"><h3>2. Identification du Dossier</h3></div>
      <div class="form-grid">
        <div class="form-group">
          <label>R√©f√©rence Client / Dossier <span class="req">*</span></label>
          <input type="text" id="ref" placeholder="Ex : 12345678">
        </div>
        <div class="form-group">
          <label>Date du Contr√¥le <span class="req">*</span></label>
          <input type="date" id="date">
        </div>
        <div class="form-group">
          <label>P√©rim√®tre de Contr√¥le <span class="req">*</span></label>
          <select id="perimetre" onchange="loadControls()">
            <option value="">‚Äî S√©lectionner ‚Äî</option>
            <option value="ouverture">Ouverture de Compte &amp; KYC</option>
            <option value="transactions">Flux &amp; Transactions</option>
            <option value="fpadm">FPADM &amp; Gel des Avoirs</option>
            <option value="ds">D√©clarations de Soup√ßon (DS)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Profil de Risque D√©clar√©</label>
          <select id="risqueClient">
            <option value="Faible">Faible</option>
            <option value="Moyen">Moyen</option>
            <option value="√âlev√©">√âlev√©</option>
          </select>
        </div>
      </div>

      <!-- Section 3 : Points de contr√¥le (affich√© dynamiquement) -->
      <div id="controls-section">
        <div class="section-sep"><h3>3. Points de Contr√¥le</h3></div>
        <div class="controls-list" id="controls-list"></div>

        <!-- Score preview -->
        <div class="score-preview" id="score-preview">
          <span class="score-label">Score conformit√©</span>
          <div class="score-bar-wrap"><div class="score-bar" id="score-bar"></div></div>
          <span class="score-value" id="score-pct">‚Äî</span>
          <span class="score-badge" id="score-badge">‚Äî</span>
        </div>

        <!-- Section 4 : Synth√®se -->
        <div class="section-sep"><h3>4. Synth√®se &amp; Plan d'Action</h3></div>
        <div class="form-group">
          <label>Commentaire Global / Plan d'Action corrective</label>
          <textarea id="global-comment" placeholder="D√©crivez les constats majeurs et les actions requises pour ce dossier‚Ä¶"></textarea>
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" onclick="addToBatch()">‚úö Valider &amp; Ajouter au Lot</button>
          <button class="btn btn-muted" onclick="resetForm()">‚Ü∫ R√©initialiser le formulaire</button>
        </div>
      </div>

    </div><!-- /card-body -->
  </div><!-- /card -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOT TABLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card">
    <div class="card-header">
      <h2><span class="icon">üìã</span> Donn√©es du Lot ‚Äî Pr√™tes pour Export</h2>
      <button class="btn btn-success" id="btn-export-all" onclick="exportBatch()" disabled>
        ‚¨á Exporter vers Excel
      </button>
    </div>
    <div class="card-body">
      <div class="stats-row" id="stats-row"></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>R√©f. Dossier</th>
              <th>Date</th>
              <th>Agence</th>
              <th>Contr√¥leur</th>
              <th>P√©rim√®tre</th>
              <th>Point de Contr√¥le</th>
              <th>√âvaluation</th>
              <th>Commentaire</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="batch-body">
            <tr>
              <td colspan="9">
                <div class="empty-state">
                  <span class="icon">üóÇ</span>
                  Aucun dossier dans le lot. Saisissez le premier contr√¥le ci-dessus.
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div><!-- /container -->

<div class="footer">
  Conformit√© Bancaire ‚Äî Syst√®me de Collecte LCB-FT | Loi n¬∞ 2015-26 du 07/08/2015 | BCT / CTAF ¬© 2026
</div>

<div class="toast-container" id="toast-container"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JAVASCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚îÄ‚îÄ‚îÄ Donn√©es : Points de contr√¥le LCB-FT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DATA = {
  ouverture: [
    { id: "KYC-01", lib: "Filtrage Sanctions, PPE et listes CTAF / ONU / GAFI" },
    { id: "KYC-02", lib: "Identification et v√©rification de l'identit√© du client (CIN, Passeport, RC)" },
    { id: "KYC-03", lib: "Identification du B√©n√©ficiaire Effectif (‚â• 25 % capital ou droits de vote)" },
    { id: "KYC-04", lib: "√âvaluation et classification du profil de risque client (approche bas√©e sur le risque)" },
    { id: "KYC-05", lib: "Collecte et conservation des pi√®ces justificatives (5 ans minimum)" },
    { id: "KYC-06", lib: "Mise √† jour p√©riodique du dossier client (diligences renforc√©es si risque √©lev√©)" },
    { id: "KYC-07", lib: "Coh√©rence de l'objet √©conomique et de la nature des op√©rations attendues" },
  ],
  transactions: [
    { id: "TRX-01", lib: "Filtrage et contr√¥le des virements internationaux (SWIFT / IBAN)" },
    { id: "TRX-02", lib: "Justification des op√©rations esp√®ces ‚â• 5 000 DT (d√©cret 2016-279)" },
    { id: "TRX-03", lib: "D√©tection de sch√©mas de fractionnement de transactions" },
    { id: "TRX-04", lib: "Coh√©rence des flux avec le profil √©conomique d√©clar√© du client" },
    { id: "TRX-05", lib: "Surveillance des op√©rations atypiques ou complexes sans justification apparente" },
    { id: "TRX-06", lib: "Contr√¥le des transactions en devise et rapatriement de fonds" },
    { id: "TRX-07", lib: "Tra√ßabilit√© des mouvements sur comptes dormants ou peu actifs" },
  ],
  fpadm: [
    { id: "FP-01", lib: "Mise en ≈ìuvre imm√©diate du gel des avoirs (R√©solutions ONU ‚Äî liste CTAF)" },
    { id: "FP-02", lib: "Reporting trimestriel √† la BCT sur le gel des avoirs" },
    { id: "FP-03", lib: "V√©rification des correspondants bancaires (pays √† haut risque GAFI)" },
    { id: "FP-04", lib: "Gestion des faux positifs et tra√ßabilit√© des d√©cisions de lev√©e de doute" },
    { id: "FP-05", lib: "Mise √† jour des listes de sanctions (fr√©quence de consultation et journalisation)" },
  ],
  ds: [
    { id: "DS-01", lib: "Utilisation du syst√®me goAML pour le d√©p√¥t des D√©clarations de Soup√ßon" },
    { id: "DS-02", lib: "Respect des d√©lais l√©gaux de transmission (sans d√©lai ‚Äî Art. 88 Loi 2015-26)" },
    { id: "DS-03", lib: "Qualit√© et compl√©tude des informations saisies dans la DS" },
    { id: "DS-04", lib: "Non-divulgation (tipping-off) au client vis√© par une DS" },
    { id: "DS-05", lib: "Formation et sensibilisation des agents √† la proc√©dure DS" },
  ],
};

// Poids des √©valuations pour le calcul du score
const WEIGHTS = { Conforme: 4, Mineur: 2, Majeur: 1, Critique: 0, NA: null };

let currentBatch = [];

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("date").value = new Date().toISOString().split("T")[0];
  renderStats();
});

// ‚îÄ‚îÄ‚îÄ FIX BUG #1 : fonction mettreAJourCodeAgence manquante ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mettreAJourCodeAgence() {
  const sel = document.getElementById("designationAgence");
  const code = sel.value; // la valeur est directement le code
  document.getElementById("codeAgence").value = code ? code : "";
}

// ‚îÄ‚îÄ‚îÄ Chargement dynamique des points de contr√¥le ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadControls() {
  const p = document.getElementById("perimetre").value;
  const section = document.getElementById("controls-section");
  const list = document.getElementById("controls-list");

  if (!p) { section.style.display = "none"; return; }

  section.style.display = "block";
  list.innerHTML = "";

  DATA[p].forEach(c => {
    const div = document.createElement("div");
    div.className = "control-item";
    div.innerHTML = `
      <div class="ctrl-label">
        <span class="ctrl-id">${c.id}</span>
        <span class="ctrl-text">${c.lib}</span>
      </div>
      <select class="eval-select" data-id="${c.id}" data-lib="${c.lib}" onchange="updateScore()">
        <option value="Conforme">‚úÖ Conforme</option>
        <option value="Mineur">‚ö†Ô∏è √âcart Mineur</option>
        <option value="Majeur">üî∂ √âcart Majeur</option>
        <option value="Critique">üî¥ Critique / Non-Conforme</option>
        <option value="NA">‚ûñ Non Applicable</option>
      </select>
      <input type="text" class="ctrl-comment" placeholder="Observation sp√©cifique‚Ä¶">
    `;
    list.appendChild(div);
  });

  updateScore();
}

// ‚îÄ‚îÄ‚îÄ Calcul du score de conformit√© ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateScore() {
  const selects = document.querySelectorAll(".eval-select");
  if (selects.length === 0) return;

  let total = 0, max = 0;
  selects.forEach(s => {
    const w = WEIGHTS[s.value];
    if (w !== null) { total += w; max += 4; }
  });

  const pct = max > 0 ? Math.round((total / max) * 100) : 0;
  const bar = document.getElementById("score-bar");
  const pctEl = document.getElementById("score-pct");
  const badge = document.getElementById("score-badge");

  pctEl.textContent = pct + " %";
  bar.style.width = pct + "%";

  let color, label;
  if (pct >= 90)      { color = "#1a7a45"; label = "Satisfaisant"; }
  else if (pct >= 70) { color = "#c47c00"; label = "√Ä am√©liorer"; }
  else if (pct >= 50) { color = "#d4620a"; label = "Insuffisant"; }
  else                { color = "#c8102e"; label = "Critique"; }

  bar.style.background = color;
  pctEl.style.color = color;
  badge.style.background = color;
  badge.textContent = label;
}

// ‚îÄ‚îÄ‚îÄ Ajouter un dossier au lot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addToBatch() {
  const ref         = document.getElementById("ref").value.trim();
  const date        = document.getElementById("date").value;
  const perimetre   = document.getElementById("perimetre").value;
  const agenceSel   = document.getElementById("designationAgence");
  const codeAgence  = document.getElementById("codeAgence").value;
  const controleur  = document.getElementById("controleur").value.trim();
  const risque      = document.getElementById("risqueClient").value;
  const globalComm  = document.getElementById("global-comment").value.trim();

  // ‚îÄ FIX BUG #2 : validation compl√®te ‚îÄ
  if (!ref || !date || !perimetre || !agenceSel.value || !controleur) {
    showToast("‚ö† Veuillez renseigner tous les champs obligatoires (agence, contr√¥leur, r√©f√©rence, date, p√©rim√®tre).", "error");
    return;
  }

  const agenceLabel = agenceSel.options[agenceSel.selectedIndex].text;
  const selects  = document.querySelectorAll(".eval-select");
  const comments = document.querySelectorAll(".ctrl-comment");

  // Calcul du score pour ce dossier
  let total = 0, max = 0;
  selects.forEach(s => {
    const w = WEIGHTS[s.value];
    if (w !== null) { total += w; max += 4; }
  });
  const score = max > 0 ? Math.round((total / max) * 100) : 0;

  selects.forEach((sel, i) => {
    currentBatch.push({
      reference:       ref,
      date:            date,
      codeAgence:      codeAgence,
      agence:          agenceLabel,   // FIX BUG #3 : √©tait document.getElementById("entite") ‚Üí null
      controleur:      controleur,
      risqueClient:    risque,
      perimetre:       perimetre,
      pointId:         sel.dataset.id,
      pointLib:        sel.dataset.lib,
      evaluation:      sel.value,
      commentaire:     comments[i].value.trim(),
      syntheseDossier: globalComm,
      scoreDossier:    score,
    });
  });

  updateBatchTable();
  renderStats();
  resetForm();
  showToast(`‚úî Dossier ${ref} ajout√© au lot (${selects.length} point(s) enregistr√©s).`, "success");
}

// ‚îÄ‚îÄ‚îÄ Supprimer une ligne du lot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function deleteFromBatch(index) {
  const ref = currentBatch[index].reference;
  currentBatch.splice(index, 1);
  updateBatchTable();
  renderStats();
  showToast(`Ligne supprim√©e du lot.`, "success");
}

// ‚îÄ‚îÄ‚îÄ Mise √† jour du tableau du lot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateBatchTable() {
  const body = document.getElementById("batch-body");
  const btnExport = document.getElementById("btn-export-all");

  if (currentBatch.length === 0) {
    body.innerHTML = `<tr><td colspan="9"><div class="empty-state"><span class="icon">üóÇ</span>Aucun dossier dans le lot.</div></td></tr>`;
    btnExport.disabled = true;
    document.getElementById("batch-count").textContent = "0";
    return;
  }

  const uniqueRefs = [...new Set(currentBatch.map(i => i.reference))];
  document.getElementById("batch-count").textContent = uniqueRefs.length;
  btnExport.disabled = false;

  body.innerHTML = "";
  currentBatch.forEach((item, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="td-mono">${item.reference}</td>
      <td class="td-mono">${item.date}</td>
      <td><small>${item.codeAgence}</small> ${item.agence}</td>
      <td>${item.controleur}</td>
      <td>${labelPerimetre(item.perimetre)}</td>
      <td><span class="ctrl-id">${item.pointId}</span> ${item.pointLib}</td>
      <td>${badgeEval(item.evaluation)}</td>
      <td>${item.commentaire || '<span style="color:#bbb">‚Äî</span>'}</td>
      <td><button class="btn-del" onclick="deleteFromBatch(${idx})">‚úï</button></td>
    `;
    body.appendChild(tr);
  });
}

// ‚îÄ‚îÄ‚îÄ Statistiques ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStats() {
  const container = document.getElementById("stats-row");
  if (currentBatch.length === 0) { container.innerHTML = ""; return; }

  const uniqueRefs = [...new Set(currentBatch.map(i => i.reference))];
  const counts = { Conforme: 0, Mineur: 0, Majeur: 0, Critique: 0, NA: 0 };
  currentBatch.forEach(i => counts[i.evaluation] = (counts[i.evaluation] || 0) + 1);

  const scores = uniqueRefs.map(ref => {
    const items = currentBatch.filter(i => i.reference === ref);
    return items[0]?.scoreDossier || 0;
  });
  const avgScore = scores.length ? Math.round(scores.reduce((a,b) => a+b) / scores.length) : 0;

  container.innerHTML = `
    <div class="stat-card"><div class="stat-val">${uniqueRefs.length}</div><div class="stat-lbl">Dossiers</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--success)">${counts.Conforme}</div><div class="stat-lbl">Conformes</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--warning)">${counts.Mineur}</div><div class="stat-lbl">√âcarts Mineurs</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--orange)">${counts.Majeur}</div><div class="stat-lbl">√âcarts Majeurs</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--danger)">${counts.Critique}</div><div class="stat-lbl">Critiques</div></div>
    <div class="stat-card"><div class="stat-val">${avgScore} %</div><div class="stat-lbl">Score moyen</div></div>
  `;
}

// ‚îÄ‚îÄ‚îÄ R√©initialisation du formulaire ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resetForm() {
  // FIX BUG #4 : perimetre et controls-section non r√©initialis√©s dans la version originale
  document.getElementById("ref").value = "";
  document.getElementById("global-comment").value = "";
  document.getElementById("perimetre").value = "";
  document.getElementById("controls-section").style.display = "none";
  document.getElementById("controls-list").innerHTML = "";
  // On conserve agence, contr√¥leur et date pour faciliter la saisie en s√©rie
}

// ‚îÄ‚îÄ‚îÄ Export Excel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportBatch() {
  if (currentBatch.length === 0) return;

  const wb = XLSX.utils.book_new();

  // Feuille 1 : D√©tail
  const excelData = currentBatch.map(item => ({
    "R√©f√©rence Dossier":      item.reference,
    "Date Contr√¥le":          item.date,
    "Code Agence":            item.codeAgence,
    "Agence / Entit√©":        item.agence,
    "Contr√¥leur":             item.controleur,
    "Risque Client":          item.risqueClient,
    "P√©rim√®tre":              labelPerimetre(item.perimetre),
    "ID Point":               item.pointId,
    "Libell√© Point":          item.pointLib,
    "√âvaluation":             item.evaluation,
    "Commentaire Sp√©cifique": item.commentaire || "",
    "Synth√®se Dossier":       item.syntheseDossier || "",
    "Score Conformit√© (%)":   item.scoreDossier,
  }));
  const ws1 = XLSX.utils.json_to_sheet(excelData);
  ws1["!cols"] = [
    {wch:16},{wch:12},{wch:10},{wch:28},{wch:20},{wch:10},
    {wch:22},{wch:8},{wch:42},{wch:14},{wch:32},{wch:40},{wch:10}
  ];
  XLSX.utils.book_append_sheet(wb, ws1, "D√©tail_Contr√¥les");

  // Feuille 2 : Synth√®se par dossier
  const uniqueRefs = [...new Set(currentBatch.map(i => i.reference))];
  const synthData = uniqueRefs.map(ref => {
    const items = currentBatch.filter(i => i.reference === ref);
    const first = items[0];
    const counts = {};
    items.forEach(i => counts[i.evaluation] = (counts[i.evaluation] || 0) + 1);
    return {
      "R√©f√©rence":      ref,
      "Date":           first.date,
      "Agence":         first.agence,
      "Contr√¥leur":     first.controleur,
      "P√©rim√®tre":      labelPerimetre(first.perimetre),
      "Conforme":       counts["Conforme"] || 0,
      "Mineur":         counts["Mineur"]   || 0,
      "Majeur":         counts["Majeur"]   || 0,
      "Critique":       counts["Critique"] || 0,
      "N/A":            counts["NA"]       || 0,
      "Score (%)":      first.scoreDossier,
      "Synth√®se":       first.syntheseDossier || "",
    };
  });
  const ws2 = XLSX.utils.json_to_sheet(synthData);
  ws2["!cols"] = [
    {wch:16},{wch:12},{wch:28},{wch:20},{wch:22},
    {wch:10},{wch:10},{wch:10},{wch:10},{wch:6},{wch:10},{wch:40}
  ];
  XLSX.utils.book_append_sheet(wb, ws2, "Synth√®se_Dossiers");

  const fileName = `Export_LCBFT_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(wb, fileName);
  showToast("‚úî Export Excel r√©ussi : " + fileName, "success");
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function labelPerimetre(p) {
  const MAP = {
    ouverture: "Ouverture & KYC",
    transactions: "Flux & Transactions",
    fpadm: "FPADM & Gel des Avoirs",
    ds: "D√©clarations de Soup√ßon",
  };
  return MAP[p] || p;
}

function badgeEval(val) {
  const MAP = {
    Conforme:  ["badge-conforme",  "‚úÖ Conforme"],
    Mineur:    ["badge-mineur",    "‚ö†Ô∏è Mineur"],
    Majeur:    ["badge-majeur",    "üî∂ Majeur"],
    Critique:  ["badge-critique",  "üî¥ Critique"],
    NA:        ["badge-na",        "‚ûñ N/A"],
  };
  const [cls, lbl] = MAP[val] || ["badge-na", val];
  return `<span class="badge ${cls}">${lbl}</span>`;
}

function showToast(msg, type = "success") {
  const c = document.getElementById("toast-container");
  const t = document.createElement("div");
  t.className = `toast ${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => {
    t.style.animation = "fadeOut 0.3s forwards";
    setTimeout(() => t.remove(), 350);
  }, 3500);
}
</script>
</body>
</html>
