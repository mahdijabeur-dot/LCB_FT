<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fiche LCB-FT Tunisie ‚Äì Consolidation par R√©f√©rence & Export Excel</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #003366; --secondary: #c8102e; --success: #28a745; --warning: #ffc107;
      --danger: #dc3545; --accent: #fd7e14; --muted: #6c757d; --bg: #f4f7f9; --card-bg: #ffffff;
    }
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { margin: 0; padding: 20px; background: var(--bg); color: #333; }
    .container { max-width: 1300px; margin: 0 auto; }
    
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, #004a8f 100%);
      color: #fff; padding: 20px 30px; border-radius: 12px; margin-bottom: 20px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .header h1 { margin: 0; font-size: 1.5rem; text-transform: uppercase; }
    
    .card {
      background: var(--card-bg); border-radius: 12px; padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
    }
    .card h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }

    .grid { display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.85rem; color: #666; }
    input, select, textarea {
      width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;
    }

    .control-item {
      padding: 12px; border-bottom: 1px solid #eee; display: grid; 
      grid-template-columns: 1fr 180px 250px; gap: 15px; align-items: center;
    }
    .control-item:hover { background: #fcfcfc; }
    .ctrl-lib { font-size: 0.9rem; font-weight: 500; }
    .ctrl-id { font-weight: bold; color: var(--primary); margin-right: 8px; background: #eef2f7; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }

    .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .btn {
      padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
      display: flex; align-items: center; gap: 8px; transition: 0.2s;
    }
    .btn-add { background: var(--primary); color: #fff; }
    .btn-export { background: var(--success); color: #fff; }
    .btn-clear { background: var(--muted); color: #fff; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .batch-table-container { overflow-x: auto; margin-top: 10px; max-height: 400px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { background: #f8f9fa; text-align: left; padding: 12px; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; }
    td { padding: 10px; border-bottom: 1px solid #eee; }
    .badge-eval { padding: 3px 8px; border-radius: 4px; color: #fff; font-weight: bold; font-size: 0.75rem; }
    
    .counter { background: var(--secondary); color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }
    .sev-badge { font-size: 0.7rem; padding: 2px 5px; border-radius: 4px; margin-left: 5px; color: #fff; text-transform: uppercase; }
    .sev-critique { background: var(--danger); }
    .sev-majeur { background: var(--accent); }
    .sev-mineur { background: var(--warning); color: #333; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div>
      <h1>üîê Consolidation LCB-FT : Enregistrement Unique</h1>
      <p style="margin:5px 0 0; opacity:0.8;">Id√©e et conception de Mahdi Ben Jabeur</p>
    </div>
    <div class="counter">Dossiers enregistr√©s : <span id="batch-count">0</span></div>
  </div>

  <!-- FORMULAIRE DE SAISIE -->
  <div class="card">
    <h3>üìù Saisie d'un nouveau dossier</h3>
    <div class="grid">
      <div><label>R√©f√©rence Unique (Contr√¥le)</label><input type="text" id="ref" placeholder="Ex: CTRL-2026-001"></div>
      <div><label>Date du Contr√¥le</label><input type="date" id="date"></div>
      <div>
        <label>P√©rim√®tre de Contr√¥le</label>
        <select id="perimetre" onchange="loadControls()">
          <option value="">-- S√©lectionner le p√©rim√®tre --</option>
          <option value="ouverture">1. Ouverture de Compte & KYC</option>
          <option value="transactions">2. Flux & Transactions (Vigilance)</option>
          <option value="fpadm">3. FPADM & Sanctions (Nouveau 2025)</option>
          <option value="monetique">4. Mon√©tique & E-Banking</option>
          <option value="credits">5. Cr√©dits & Engagements</option>
          <option value="be">6. Bancaire √âtranger & Change</option>
          <option value="ds">7. D√©clarations de Soup√ßon (goAML)</option>
          <option value="gov">8. Gouvernance & Dispositif Interne</option>
        </select>
      </div>
      <div><label>Agence / Entit√©</label><input type="text" id="entite" placeholder="Code Agence"></div>
    </div>

    <div id="controls-container" style="margin-top:25px; display:none; border-top: 2px solid #f0f2f5; padding-top:20px;">
      <div id="controls-list"></div>
      
      <div style="margin-top:25px;" class="grid">
        <div>
          <label>Synth√®se Qualitative</label>
          <textarea id="global-comment" rows="3" placeholder="Constats principaux..."></textarea>
        </div>
        <div>
          <label>Plan d'Action</label>
          <textarea id="action-plan" rows="3" placeholder="Recommandations..."></textarea>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-add" onclick="saveDossier()">üíæ Enregistrer le Dossier (Unique)</button>
        <button class="btn btn-clear" onclick="resetForm()">üîÑ R√©initialiser</button>
      </div>
    </div>
  </div>

  <!-- TABLEAU DES ENREGISTREMENTS -->
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 style="margin:0; border:none; padding:0;">üìã Liste des Dossiers Consolid√©s</h3>
      <button class="btn btn-export" id="btn-export-all" onclick="exportBatch()" disabled>üìä Exporter tous les dossiers vers Excel (.xlsx)</button>
    </div>
    <div class="batch-table-container">
      <table id="batch-table">
        <thead>
          <tr>
            <th>R√©f√©rence</th>
            <th>Date</th>
            <th>P√©rim√®tre</th>
            <th>Score / Conformit√©</th>
            <th>Synth√®se</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="batch-body">
          <tr><td colspan="6" style="text-align:center; color:#999; padding:30px;">Aucun enregistrement unique.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="footer">
Id√©e et conception de Mahdi Ben Jabeur  </div>
</div>

<script>
const REFERENTIEL = {
  "ouverture": [
    {id:"KYC-01", sev:"critique", lib:"Filtrage Sanctions & PPE"},
    {id:"KYC-02", sev:"critique", lib:"Identification BE (‚â• 20%)"},
    {id:"KYC-03", sev:"majeur", lib:"Scoring LCB-FT"},
    {id:"KYC-04", sev:"majeur", lib:"Origine des fonds (EDD)"},
    {id:"KYC-05", sev:"majeur", lib:"Validation hi√©rarchique"},
    {id:"KYC-06", sev:"mineur", lib:"Compl√©tude dossier"},
    {id:"KYC-07", sev:"majeur", lib:"KYC Review p√©riodique"}
  ],
  "transactions": [
    {id:"TRX-01", sev:"critique", lib:"Filtrage Swift"},
    {id:"TRX-02", sev:"majeur", lib:"Esp√®ces ‚â• 20 000 DT"},
    {id:"TRX-03", sev:"majeur", lib:"Smurfing"},
    {id:"TRX-04", sev:"majeur", lib:"Zones GAFI"},
    {id:"TRX-05", sev:"critique", lib:"Blocage match gel"},
    {id:"TRX-06", sev:"majeur", lib:"Coh√©rence flux/KYC"}
  ],
  "fpadm": [
    {id:"FP-01", sev:"critique", lib:"Gel imm√©diat ONU"},
    {id:"FP-02", sev:"critique", lib:"Reporting BCT (2025-17)"},
    {id:"FP-03", sev:"majeur", lib:"Risque Prolif√©ration"},
    {id:"FP-04", sev:"majeur", lib:"Biens double usage"},
    {id:"FP-05", sev:"critique", lib:"Correspondants vs FPADM"}
  ],
  "monetique": [
    {id:"MON-01", sev:"majeur", lib:"KYC cartes devises"},
    {id:"MON-02", sev:"majeur", lib:"Plafonds vs profil"},
    {id:"MON-03", sev:"critique", lib:"Monitoring E-commerce"},
    {id:"MON-04", sev:"mineur", lib:"Archivage logs"},
    {id:"MON-05", sev:"majeur", lib:"Filtrage commer√ßants"}
  ],
  "credits": [
    {id:"CRD-01", sev:"critique", lib:"Origine fonds remboursements"},
    {id:"CRD-02", sev:"majeur", lib:"Usage final fonds"},
    {id:"CRD-03", sev:"majeur", lib:"KYC > 100 kDT"},
    {id:"CRD-04", sev:"majeur", lib:"Analyse post-d√©caissement"}
  ],
  "be": [
    {id:"CBR-01", sev:"critique", lib:"Wolfsberg Questionnaire"},
    {id:"CBR-02", sev:"critique", lib:"Shell Banks"},
    {id:"CBR-03", sev:"majeur", lib:"Change manuel (20k DT)"},
    {id:"CBR-04", sev:"majeur", lib:"D√©claration douanes"},
    {id:"CBR-05", sev:"majeur", lib:"Patriot Act"}
  ],
  "ds": [
    {id:"DS-01", sev:"critique", lib:"Plateforme goAML"},
    {id:"DS-02", sev:"critique", lib:"D√©lais (Imm√©diatet√©)"},
    {id:"DS-03", sev:"majeur", lib:"Confidentialit√© (Tipping-off)"},
    {id:"DS-04", sev:"majeur", lib:"Qualit√© motifs"},
    {id:"DS-05", sev:"majeur", lib:"Conservation CTAF"}
  ],
  "gov": [
    {id:"GOV-01", sev:"critique", lib:"Ratio RCLABC 1/50"},
    {id:"GOV-02", sev:"majeur", lib:"Formation 100%"},
    {id:"GOV-03", sev:"majeur", lib:"Code d√©ontologie (2025-17)"},
    {id:"GOV-04", sev:"majeur", lib:"D√©lai 5j CTAF"},
    {id:"GOV-05", sev:"majeur", lib:"Comit√© LCB-FT"},
    {id:"GOV-06", sev:"majeur", lib:"Test ind√©pendant"}
  ]
};

let dossiersConsolides = [];

function loadControls() {
  const p = document.getElementById("perimetre").value;
  const container = document.getElementById("controls-container");
  const list = document.getElementById("controls-list");
  if (!p) { container.style.display = "none"; return; }
  container.style.display = "block";
  list.innerHTML = "";
  REFERENTIEL[p].forEach(c => {
    const div = document.createElement("div");
    div.className = "control-item";
    div.innerHTML = `
      <div class="ctrl-lib"><span class="ctrl-id">${c.id}</span> ${c.lib} <span class="sev-badge sev-${c.sev}">${c.sev}</span></div>
      <select class="eval-select" data-id="${c.id}" data-lib="${c.lib}">
        <option value="Conforme">‚úÖ Conforme</option>
        <option value="Mineur">‚ö†Ô∏è Mineur</option>
        <option value="Majeur">üî∂ Majeur</option>
        <option value="Critique">üî¥ Critique</option>
        <option value="NA">‚ûñ N/A</option>
      </select>
      <input type="text" class="ctrl-comment" placeholder="Observation...">
    `;
    list.appendChild(div);
  });
}

function saveDossier() {
  const ref = document.getElementById("ref").value;
  const date = document.getElementById("date").value;
  const perimetre = document.getElementById("perimetre").value;
  if (!ref || !date || !perimetre) { alert("R√©f√©rence, Date et P√©rim√®tre obligatoires."); return; }

  const selects = document.querySelectorAll(".eval-select");
  const comments = document.querySelectorAll(".ctrl-comment");
  
  let details = {};
  let stats = { conforme: 0, total: 0, critique: 0 };

  selects.forEach((sel, index) => {
    const val = sel.value;
    details[sel.dataset.id] = { eval: val, obs: comments[index].value };
    if (val !== "NA") {
      stats.total++;
      if (val === "Conforme") stats.conforme++;
      if (val === "Critique") stats.critique++;
    }
  });

  const score = stats.total > 0 ? Math.round((stats.conforme / stats.total) * 100) : 0;
  let conformite = score >= 95 ? "CONFORME" : "√Ä AM√âLIORER";
  if (stats.critique > 0) conformite = "NON CONFORME";

  const dossier = {
    reference: ref,
    date: date,
    perimetre: perimetre,
    agence: document.getElementById("entite").value || "N/A",
    score: score + "%",
    conformite: conformite,
    synthese: document.getElementById("global-comment").value,
    planAction: document.getElementById("action-plan").value,
    details: details
  };

  // On remplace si la r√©f√©rence existe d√©j√†, sinon on ajoute
  const index = dossiersConsolides.findIndex(d => d.reference === ref);
  if (index !== -1) dossiersConsolides[index] = dossier;
  else dossiersConsolides.push(dossier);

  updateTable();
  resetForm();
  alert("Dossier '" + ref + "' enregistr√© avec succ√®s.");
}

function updateTable() {
  const body = document.getElementById("batch-body");
  const count = document.getElementById("batch-count");
  const btnExport = document.getElementById("btn-export-all");

  if (dossiersConsolides.length === 0) {
    body.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999; padding:30px;">Aucun enregistrement.</td></tr>';
    count.textContent = "0";
    btnExport.disabled = true;
    return;
  }

  count.textContent = dossiersConsolides.length;
  btnExport.disabled = false;
  body.innerHTML = "";
  dossiersConsolides.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${d.reference}</b></td>
      <td>${d.date}</td>
      <td>${d.perimetre}</td>
      <td><span class="badge-eval" style="background:${d.conformite==='CONFORME'?'#28a745':(d.conformite==='NON CONFORME'?'#dc3545':'#fd7e14')}">${d.score} - ${d.conformite}</span></td>
      <td>${d.synthese.substring(0, 30)}...</td>
      <td><button onclick="deleteDossier('${d.reference}')" style="color:red; border:none; background:none; cursor:pointer;">üóëÔ∏è</button></td>
    `;
    body.appendChild(tr);
  });
}

function deleteDossier(ref) {
  dossiersConsolides = dossiersConsolides.filter(d => d.reference !== ref);
  updateTable();
}

function resetForm() {
  document.getElementById("ref").value = "";
  document.getElementById("global-comment").value = "";
  document.getElementById("action-plan").value = "";
  loadControls();
}

function exportBatch() {
  const wb = XLSX.utils.book_new();
  
  // On pr√©pare les donn√©es : une ligne par dossier
  const excelData = dossiersConsolides.map(d => {
    let row = {
      "R√©f√©rence Contr√¥le": d.reference,
      "Date": d.date,
      "P√©rim√®tre": d.perimetre,
      "Agence": d.agence,
      "Score Global": d.score,
      "Statut Conformit√©": d.conformite,
      "Synth√®se": d.synthese,
      "Plan d'Action": d.planAction
    };
    // On ajoute les points de contr√¥le en colonnes dynamiques
    for (let id in d.details) {
      row[id + " (Eval)"] = d.details[id].eval;
      row[id + " (Obs)"] = d.details[id].obs;
    }
    return row;
  });

  const ws = XLSX.utils.json_to_sheet(excelData);
  XLSX.utils.book_append_sheet(wb, ws, "Reporting_Consolide");
  XLSX.writeFile(wb, `Reporting_LCBFT_Consolide_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>
</body>
</html>
